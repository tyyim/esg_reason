# MIPROv2 Optimization Architecture for MMESGBench

## ๐ฏ Overview

**Goal**: Optimize from 55.8% baseline (wrong 80% split) โ Establish NEW baseline on 20% split โ Optimize with MIPROv2

**Key Insight**: Qwen Max serves dual roles:
1. **Meta-optimizer** (MIPROv2): Proposes better prompts/instructions
2. **Student model** (RAG Pipeline): Executes reasoning with optimized prompts

---

## ๐ Phase 1: Baseline Architecture (CURRENT)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    MMESGBench Baseline RAG                       โ
โ                  (PostgreSQL + Qwen Embeddings)                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

INPUT: Question + Doc ID + Answer Format
  โ
  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  โ                                                              โ
  โผ                                                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                                โ
โ  RETRIEVAL STAGE             โ                                โ
โ  PostgreSQL + pgvector       โ                                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค                                โ
โ โข Query: Question            โ                                โ
โ โข Embeddings: Qwen v4 (1024) โ                                โ
โ โข Filter: doc_id             โ                                โ
โ โข Top-K: 5 chunks            โ                                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                                โ
  โ                                                              โ
  โ Retrieved Context (5 chunks with similarity scores)         โ
  โ                                                              โ
  โผ                                                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  STAGE 1: REASONING (ChainOfThought)                         โโ
โ  Model: Qwen Max                                             โโ
โ  Temperature: 0.0                                            โโ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโคโ
โ  Signature: ESGReasoning                                     โโ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โโ
โ  โ Inputs:                                                 โ โโ
โ  โ โข context: Retrieved chunks                            โ โโ
โ  โ โข question: User question                              โ โโ
โ  โ โข doc_id: Source document                              โ โโ
โ  โ                                                         โ โโ
โ  โ Instruction (DEFAULT - to be optimized):               โ โโ
โ  โ "Analyze the context and provide detailed reasoning    โ โโ
โ  โ  to answer the question based on ESG documents."       โ โโ
โ  โ                                                         โ โโ
โ  โ Output:                                                 โ โโ
โ  โ โข analysis: Detailed chain-of-thought reasoning        โ โโ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โโ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  โ                                                              โ
  โ Analysis with reasoning                                     โ
  โ                                                              โ
  โผ                                                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  STAGE 2: EXTRACTION (Predict)                               โโ
โ  Model: Qwen Max                                             โโ
โ  Temperature: 0.0                                            โโ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโคโ
โ  Signature: AnswerExtraction                                 โโ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โโ
โ  โ Inputs:                                                 โ โโ
โ  โ โข analysis: Chain-of-thought from Stage 1              โ โโ
โ  โ โข answer_format: Expected format (Str/Int/Float/List)  โ โโ
โ  โ                                                         โ โโ
โ  โ Instruction (DEFAULT - to be optimized):               โ โโ
โ  โ "Extract the final answer from the analysis in the     โ โโ
โ  โ  specified format. Return ONLY the answer value."      โ โโ
โ  โ                                                         โ โโ
โ  โ Output:                                                 โ โโ
โ  โ โข answer: Extracted answer in specified format         โ โโ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โโ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  โ                                                              โ
  โ Final Answer                                                โ
  โ                                                              โ
  โผ                                                              โ
OUTPUT: answer (evaluated against ground truth)                 โ
                                                                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
BASELINE PERFORMANCE (on wrong 80% split):                      โ
โข Accuracy: 55.8% (416/746 questions)                           โ
โข Issue: Used wrong train split (should be 20% not 80%)         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Phase 2: MIPROv2 Optimization Process

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    MIPROv2 Meta-Optimizer                        โ
โ                    (Qwen Max as Optimizer)                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  STEP 1: BASELINE EVALUATION (on correct 20% split)             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  โข Evaluate baseline RAG on 186 training questions (20%)        โ
โ  โข Use DEFAULT instructions (shown above)                        โ
โ  โข Measure: accuracy with MMESGBench fuzzy matching             โ
โ  โข Expected: ~55-60% baseline (to be established)               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  โ
  โ Baseline accuracy established
  โ
  โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  STEP 2: INSTRUCTION PROPOSAL (Qwen Max as Meta-Optimizer)      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  MIPROv2 generates candidate instructions for:                  โ
โ  โข ESGReasoning signature (Stage 1)                             โ
โ  โข AnswerExtraction signature (Stage 2)                         โ
โ                                                                  โ
โ  Process:                                                        โ
โ  1. Analyze baseline failures                                   โ
โ  2. Generate num_candidates=10 alternative instructions         โ
โ  3. Each candidate proposes how to improve reasoning            โ
โ                                                                  โ
โ  Example candidate instructions:                                โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ Candidate 1 (ESGReasoning):                                โ โ
โ  โ "First identify key ESG metrics mentioned. Then trace      โ โ
โ  โ  evidence from tables/charts. Finally synthesize findings  โ โ
โ  โ  with explicit citation to page numbers."                  โ โ
โ  โ                                                             โ โ
โ  โ Candidate 2 (AnswerExtraction):                            โ โ
โ  โ "Locate the most specific numerical value or categorical  โ โ
โ  โ  answer. If format is List, extract all items. Verify     โ โ
โ  โ  format matches expected type before returning."           โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  โ
  โ Generated 10 candidate instruction sets
  โ
  โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  STEP 3: CANDIDATE EVALUATION (Qwen Max as Student)             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  For each candidate instruction set:                             โ
โ  1. Create RAG module with candidate instructions                โ
โ  2. Evaluate on subset of training data (~20-50 questions)       โ
โ  3. Measure accuracy with MMESGBench fuzzy matching              โ
โ  4. Track which candidates perform best                          โ
โ                                                                  โ
โ  MIPROv2 trials: 20 iterations                                  โ
โ  โข Each trial tests different instruction combinations           โ
โ  โข Keeps best-performing instructions                            โ
โ  โข Progressively refines based on failures                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  โ
  โ Best instruction set identified
  โ
  โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  STEP 4: FEW-SHOT DEMONSTRATIONS (Optional)                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  MIPROv2 can also optimize few-shot examples:                   โ
โ  โข max_bootstrapped_demos: 4                                    โ
โ  โข max_labeled_demos: 4                                         โ
โ  โข Selects best examples that improve accuracy                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  โ
  โ Optimized instructions + few-shot examples
  โ
  โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  STEP 5: FINAL OPTIMIZED MODULE                                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  Output: MMESGBenchRAG with optimized:                          โ
โ  โข ESGReasoning instruction (better than default)               โ
โ  โข AnswerExtraction instruction (better than default)           โ
โ  โข Optional: Few-shot demonstrations                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ฏ Phase 3: Optimized Architecture

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    OPTIMIZED MMESGBench RAG                      โ
โ              (Same architecture, BETTER prompts)                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

IDENTICAL PIPELINE STRUCTURE:
  Retrieval โ Stage 1 (Reasoning) โ Stage 2 (Extraction) โ Answer

WHAT CHANGED:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โจ OPTIMIZED ESGReasoning Instruction                          โ
โ  (Example - actual instruction generated by MIPROv2)             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ "When analyzing ESG documents:                             โ โ
โ  โ  1. Scan context for tables, charts, and numerical data   โ โ
โ  โ  2. Identify specific metrics related to the question     โ โ
โ  โ  3. Cross-reference multiple sources if available         โ โ
โ  โ  4. Cite page numbers and section references              โ โ
โ  โ  5. Handle ambiguity by stating confidence levels"        โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โจ OPTIMIZED AnswerExtraction Instruction                      โ
โ  (Example - actual instruction generated by MIPROv2)             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ "Extract the final answer:                                 โ โ
โ  โ  โข For numbers: Use exact values from text, not ranges    โ โ
โ  โ  โข For strings: Match terminology from document           โ โ
โ  โ  โข For lists: Extract complete items, check completeness  โ โ
โ  โ  โข Format validation: Verify type before returning        โ โ
โ  โ  โข If uncertain: Return most specific answer found"       โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
EXPECTED PERFORMANCE IMPROVEMENT:
โข Baseline (20% split): TBD (to be established)
โข Target: Baseline + 1-2% absolute improvement
โข Method: Better prompts โ better reasoning โ higher accuracy
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Evaluation Strategy

### Dataset Splits (CORRECTED - 20/10/70)
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Train Set: 186 questions (20%)                                 โ
โ  โข Used for: MIPROv2 optimization                               โ
โ  โข Role: Generate and test candidate instructions              โ
โ  โข Baseline established on this set                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Dev Set: 93 questions (10%)                                    โ
โ  โข Used for: Validation during optimization                     โ
โ  โข Role: Prevent overfitting, tune hyperparameters             โ
โ  โข Final optimized accuracy measured here                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Test Set: 654 questions (70%)                                  โ
โ  โข Used for: Final evaluation (held out)                        โ
โ  โข Role: Compare baseline vs optimized on unseen data          โ
โ  โข Published results will come from this set                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### Comparison Framework
```
                    TRAIN (186)      DEV (93)       TEST (654)
                    โโโโโโโโโโโโโ    โโโโโโโโโโ     โโโโโโโโโโโ
Baseline            Establish %      Measure %      Final eval
(default prompts)

MIPROv2 Optimized   Optimize here    Validate %     Final eval
(better prompts)

Target              N/A              +1-2% over     +1-2% over
                                     baseline       baseline
```

---

## ๐ Key Architectural Decisions

### โ Same LLM for Meta-Optimizer and Student
**Decision**: Use Qwen Max for both roles
- **Meta-optimizer**: Proposes better instructions (MIPROv2)
- **Student model**: Executes RAG with those instructions
- **Rationale**: Common in DSPy, leverages model's understanding of its own capabilities

### โ Two-Stage Reasoning Preserved
**Decision**: Keep ChainOfThought โ Extraction architecture
- **Stage 1**: Analyze context with reasoning (optimized instruction)
- **Stage 2**: Extract structured answer (optimized instruction)
- **Rationale**: Proven effective, allows targeted optimization of each stage

### โ PostgreSQL Retrieval Fixed
**Decision**: Do NOT optimize retrieval, only prompts
- **Retrieval**: PostgreSQL + pgvector (fixed at top-5)
- **Optimization**: Only ESGReasoning and AnswerExtraction signatures
- **Rationale**: Focus on prompt engineering, not retrieval architecture

### โ MMESGBench Evaluation Preserved
**Decision**: Use exact MMESGBench fuzzy matching
- **Metric**: ANLS fuzzy matching (threshold: 0.5)
- **Float tolerance**: ยฑ1% relative tolerance
- **List matching**: 80% threshold
- **Rationale**: 100% compatibility with paper results

---

## ๐ฏ Success Criteria

### Baseline Establishment (First)
- [ ] Evaluate on correct 186 questions (20% split)
- [ ] Establish baseline accuracy with DEFAULT prompts
- [ ] Expected: Similar to previous results (~55-60%)

### MIPROv2 Optimization (Second)
- [ ] Generate 10 candidate instruction sets
- [ ] Run 20 optimization trials
- [ ] Achieve +1-2% improvement on dev set

### Final Validation (Third)
- [ ] Evaluate optimized model on dev set (93 questions)
- [ ] Measure improvement over baseline
- [ ] Save optimized module for test set evaluation

---

## ๐ Implementation Notes

### Configuration
```python
MIPROv2(
    metric=mmesgbench_accuracy,      # MMESGBench fuzzy matching
    num_candidates=10,               # Instruction variations
    init_temperature=1.0,            # Diversity in proposals
    verbose=True                     # Track optimization progress
)

optimizer.compile(
    student=baseline_rag,            # RAG module to optimize
    trainset=train_set,              # 186 questions (20%)
    num_trials=20,                   # Optimization iterations
    max_bootstrapped_demos=4,        # Auto-generated examples
    max_labeled_demos=4              # Human-labeled examples
)
```

### Estimated Runtime
- Baseline evaluation (186 questions): ~10-15 minutes
- MIPROv2 optimization (20 trials): ~30-60 minutes
- Dev set evaluation (93 questions): ~5-8 minutes
- **Total**: ~45-83 minutes

### Checkpoint Strategy
- MIPROv2 automatically saves progress
- Can resume if interrupted
- Final optimized module saved to disk

---

## ๐ Next Steps

1. **Re-run baseline** on correct 186 questions (20% split)
2. **Launch MIPROv2** optimization with corrected splits
3. **Evaluate on dev set** (93 questions)
4. **Compare** baseline vs optimized performance
5. **Document** instruction improvements and accuracy gains

---

**Generated**: 2025-10-07
**Status**: Ready for execution with corrected 20/10/70 split
**Baseline**: TBD (to be established on 186 questions)
**Target**: Baseline + 1-2% improvement via optimized prompts
